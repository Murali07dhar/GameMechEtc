<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detective Evidence Board</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://css.gg/css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom font for a typewriter/handwritten feel */
        .font-special-elite {
            font-family: 'Special Elite', monospace;
        }

        /* Black background for the board */
        .corkboard-bg {
            background-color: #111827; /* A dark, near-black color */
        }

        /* Base styling for all evidence items */
        .evidence-item {
            position: absolute;
            z-index: 10;
            width: 260px;
            min-height: 120px;
            box-shadow: 5px 5px 10px rgba(0,0,0,0.4);
            cursor: move; /* Indicates the item is movable */
            transition: box-shadow 0.2s ease-out, transform 0.1s ease-out;
            resize: both;
            overflow: hidden; /* Hides resize handle overflow */
        }
        
        /* Specific styling for note items */
        .note-item {
            padding: 0.75rem;
            padding-top: 1.5rem; /* Adjusted for pin */
            background-color: #fefcbf; /* A yellowish paper color */
            color: #000;
            border-radius: 2px;
            border-left: 5px solid #b91c1c; /* A deep red border */
        }
        
        /* Specific styling for photo items (polaroid style) */
        .photo-item {
            padding: 1rem;
            padding-top: 1.5rem; /* Adjusted for pin */
            padding-bottom: 3rem; /* More space at the bottom for the polaroid look */
            background-color: #f8fafc; /* Off-white */
            border-radius: 1px;
        }

        .photo-item .photo-content {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: #374151; /* gray-700 for image placeholder */
            border: 1px solid #4b5563; /* gray-600 */
        }
        
        /* Style for the draggable note template in the toolbar */
        #note-template {
            cursor: grab;
            transition: transform 0.2s ease-in-out;
            transform: rotate(-2deg);
        }
        #note-template:hover {
            transform: rotate(-2deg) scale(1.05);
        }
        #note-template:active {
            cursor: grabbing;
            transform: scale(0.95) rotate(0deg);
        }

        /* Visual feedback when dragging over the board */
        .drag-over {
            background-color: rgba(0,0,0,0.2);
            box-shadow: inset 0 0 0 4px #b91c1c;
        }

        /* Class for an item being dragged */
        .dragging {
            z-index: 1000; /* Bring to front */
            box-shadow: 10px 10px 15px rgba(0,0,0,0.5);
            opacity: 0.85;
            cursor: grabbing;
            transform-origin: center center;
        }

        /* Blue pushpin styling */
        .pin {
            position: absolute;
            top: -5px; /* Lowered the pin slightly */
            left: 50%;
            transform: translateX(-50%); /* Only center horizontally */
            width: 20px;
            height: 20px;
            background: radial-gradient(circle, #93c5fd 0%, #3b82f6 100%); /* light blue to medium blue */
            border-radius: 50%;
            border: 1px solid #1e40af; /* dark blue */
            box-shadow: 0 2px 3px rgba(0,0,0,0.6), inset 0 0 4px rgba(255,255,255,0.4);
            z-index: 11;
        }

        /* General rotation handle styling */
        .rotate-handle {
            position: absolute;
            bottom: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background-color: rgba(0,0,0,0.2);
            border-radius: 50%;
            cursor: alias;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 12;
            transition: background-color 0.2s;
        }
        .rotate-handle:hover {
            background-color: rgba(0,0,0,0.4);
        }
        .rotate-handle svg {
            width: 14px;
            height: 14px;
            color: black;
            pointer-events: none; /* Make sure handle itself captures events */
        }
        
        /* Specific override for photo item rotate handle */
        .photo-item .rotate-handle {
            right: auto;
            left: 50%;
            transform: translateX(-50%);
        }

        .drop-hint {
            position: absolute;
            top: 1rem;
            left: 1rem;
            color: rgba(255,255,255,0.2);
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-900 font-sans antialiased overflow-hidden h-screen flex flex-col">

    <!-- Header & Toolbar -->
    <header class="bg-black/50 backdrop-blur-sm text-white p-3 shadow-lg z-30 flex justify-between items-center border-b border-gray-700">
        <h1 class="text-xl md:text-2xl font-bold font-special-elite tracking-wider">CASE FILE: UNASSIGNED</h1>
        <div class="flex items-center space-x-4">
            <span class="text-gray-400 font-semibold text-sm">DRAG TO BOARD:</span>
            <!-- Draggable Note Template -->
            <div id="note-template" draggable="true" class="p-2 bg-yellow-100 text-red-800 font-bold uppercase text-xs rounded-sm shadow-md text-center w-32 border-l-4 border-red-800">
                Field Note
            </div>
        </div>
    </header>

    <!-- Main Evidence Board Area -->
    <main id="board-container" class="relative flex-grow overflow-hidden">
        <div id="corkboard" class="absolute inset-0 corkboard-bg">
             <div class="drop-hint">Drag & drop images from your computer here</div>
            <!-- Dropped evidence items will be added here by JavaScript -->
        </div>
    </main>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBIQBvbJP8QvbJvplG4oo7SbSpI9o5oEkQ",
            authDomain: "storyplannerv3.firebaseapp.com",
            projectId: "storyplannerv3",
            storageBucket: "storyplannerv3.appspot.com",
            messagingSenderId: "36866781156",
            appId: "1:36866781156:web:2b1dd18e2593905036e1f1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const evidenceCol = collection(db, 'evidence');

        // Sign in user anonymously to get permissions
        signInAnonymously(auth).catch((error) => {
            console.error("Anonymous sign-in failed:", error);
            alert("Could not connect to the collaborative session. Please check your Firebase security rules.");
        });

        document.addEventListener('DOMContentLoaded', () => {
            const noteTemplate = document.getElementById('note-template');
            const corkboard = document.getElementById('corkboard');

            // --- Global State for Interactions ---
            let activeItem = null;
            let action = null; // 'move', 'rotate'
            let offset = { x: 0, y: 0, angle: 0 };
            
            // --- Real-time listener for Firestore ---
            onSnapshot(evidenceCol, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const itemData = change.doc.data();
                    const itemId = change.doc.id;
                    let itemEl = document.getElementById(itemId);

                    if (change.type === 'added') {
                        if (!itemEl) { // Make sure we don't re-add our own items
                           if (itemData.type === 'note') {
                                createNoteOnBoard(itemId, itemData);
                           } else if (itemData.type === 'image') {
                                createImageOnBoard(itemId, itemData);
                           }
                        }
                    }
                    if (change.type === 'modified') {
                        if (itemEl) {
                           updateItemOnBoard(itemEl, itemData);
                        }
                    }
                    if (change.type === 'removed') {
                        if (itemEl) {
                            itemEl.remove();
                        }
                    }
                });
            });


            // --- Drag and Drop Handling ---

            noteTemplate.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', 'note');
            });

            corkboard.addEventListener('dragover', (e) => {
                e.preventDefault();
                corkboard.classList.add('drag-over');
            });
            
            corkboard.addEventListener('dragleave', () => {
                corkboard.classList.remove('drag-over');
            });

            corkboard.addEventListener('drop', (e) => {
                e.preventDefault();
                corkboard.classList.remove('drag-over');

                const boardRect = corkboard.getBoundingClientRect();
                const x = e.clientX - boardRect.left - 130;
                const y = e.clientY - boardRect.top - 60;
                const rotation = Math.random() * 8 - 4;

                // Check for dropped files first
                if (e.dataTransfer.files && e.dataTransfer.files.length > 0) {
                    handleFileDrop(e.dataTransfer.files, x, y, rotation);
                    e.dataTransfer.clearData();
                } else {
                    const dataType = e.dataTransfer.getData('text/plain');
                    if (dataType === 'note') {
                        addDoc(evidenceCol, {
                            type: 'note',
                            text: 'Enter observation...',
                            x: x,
                            y: y,
                            rotation: rotation,
                            width: 260,
                            height: 120
                        });
                    }
                }
            });
            
            function handleFileDrop(files, x, y, rotation) {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (loadEvent) => {
                             addDoc(evidenceCol, {
                                type: 'image',
                                src: loadEvent.target.result,
                                x: x,
                                y: y,
                                rotation: rotation,
                                width: 260,
                                height: 300
                            });
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }

            // --- Item Creation and Update Functions ---
            
            function createNoteOnBoard(id, data) {
                const note = document.createElement('div');
                note.className = 'evidence-item note-item';
                note.id = id;
                
                note.innerHTML = `
                    <div class="pin"></div>
                    <div class="font-special-elite note-content" contenteditable="true">${data.text}</div>
                    <div class="rotate-handle">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.695v-4.992m0 0h-4.992m4.992 0l-3.181-3.183a8.25 8.25 0 00-11.667 0L2.985 7.352" /></svg>
                    </div>
                `;
                setupNewItem(note, data);
            }
            
            function createImageOnBoard(id, data) {
                const photo = document.createElement('div');
                photo.className = 'evidence-item photo-item';
                photo.id = id;
                
                photo.innerHTML = `
                    <div class="pin"></div>
                    <img src="${data.src}" class="photo-content" alt="Dropped Evidence"/>
                    <div class="rotate-handle">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0l3.181 3.183a8.25 8.25 0 0011.667 0l3.181-3.183m-4.991-2.695v-4.992m0 0h-4.992m4.992 0l-3.181-3.183a8.25 8.25 0 00-11.667 0L2.985 7.352" /></svg>
                    </div>
                `;
                setupNewItem(photo, data);
            }

            function setupNewItem(item, data) {
                updateItemOnBoard(item, data);
                corkboard.appendChild(item);
                
                // Add event listeners
                item.addEventListener('mousedown', onMoveStart);
                item.addEventListener('dblclick', onDeleteItem);
                item.querySelector('.rotate-handle').addEventListener('mousedown', onRotateStart);
                
                const contentDiv = item.querySelector('.note-content');
                if (contentDiv) {
                    contentDiv.addEventListener('blur', (e) => {
                        const docRef = doc(db, 'evidence', item.id);
                        updateDoc(docRef, { text: e.target.innerHTML });
                    });
                }
            }
            
            function updateItemOnBoard(item, data) {
                 item.style.left = `${data.x}px`;
                item.style.top = `${data.y}px`;
                item.style.width = `${data.width}px`;
                item.style.height = `${data.height}px`;
                item.style.transform = `rotate(${data.rotation}deg)`;
                item.dataset.rotation = data.rotation;

                const contentDiv = item.querySelector('.note-content');
                if (contentDiv && contentDiv.innerHTML !== data.text) {
                    contentDiv.innerHTML = data.text;
                }
            }

            // --- Interaction Handlers ---

            function onDeleteItem(e) {
                const itemEl = e.currentTarget;
                if (confirm('Are you sure you want to delete this item?')) {
                    const docRef = doc(db, 'evidence', itemEl.id);
                    deleteDoc(docRef);
                }
            }

            function onMoveStart(e) {
                if (e.target.isContentEditable || e.target.classList.contains('rotate-handle')) {
                    return;
                }
                e.preventDefault();
                
                activeItem = e.currentTarget;
                action = 'move';
                activeItem.classList.add('dragging');
                
                offset = {
                    x: e.clientX - activeItem.getBoundingClientRect().left,
                    y: e.clientY - activeItem.getBoundingClientRect().top,
                    angle: parseFloat(activeItem.dataset.rotation || 0)
                };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }

            function onRotateStart(e) {
                e.preventDefault();
                e.stopPropagation();

                activeItem = e.currentTarget.parentElement;
                action = 'rotate';
                activeItem.classList.add('dragging');
                
                const rect = activeItem.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                
                const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
                const currentRotation = parseFloat(activeItem.dataset.rotation || 0);

                offset = { angle: startAngle - currentRotation };

                document.addEventListener('mousemove', onMouseMove);
                document.addEventListener('mouseup', onMouseUp);
            }
            
            function onMouseMove(e) {
                if (!activeItem) return;

                if (action === 'move') {
                    const boardRect = corkboard.getBoundingClientRect();
                    let x = e.clientX - boardRect.left - offset.x;
                    let y = e.clientY - boardRect.top - offset.y;

                    x = Math.max(0, Math.min(x, boardRect.width - activeItem.offsetWidth));
                    y = Math.max(0, Math.min(y, boardRect.height - activeItem.offsetHeight));

                    activeItem.style.left = `${x}px`;
                    activeItem.style.top = `${y}px`;
                    activeItem.style.transform = `rotate(${offset.angle}deg) scale(1.05)`;

                } else if (action === 'rotate') {
                    const rect = activeItem.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    
                    const moveAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
                    const newRotation = moveAngle - offset.angle;
                    
                    activeItem.dataset.rotation = newRotation;
                    activeItem.style.transform = `rotate(${newRotation}deg) scale(1.05)`;
                }
            }

            function onMouseUp() {
                if (activeItem) {
                    activeItem.classList.remove('dragging');
                    const finalRotation = parseFloat(activeItem.dataset.rotation || 0);
                    activeItem.style.transform = `rotate(${finalRotation}deg)`;
                    
                    const docRef = doc(db, 'evidence', activeItem.id);
                    updateDoc(docRef, {
                        x: parseFloat(activeItem.style.left),
                        y: parseFloat(activeItem.style.top),
                        rotation: finalRotation,
                        width: activeItem.offsetWidth,
                        height: activeItem.offsetHeight
                    });
                }
                activeItem = null;
                action = null;
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            }
        });
    </script>
</body>
</html>
